{% extends 'base.html' %}
{% block title %}Relat√≥rio por Compet√™ncia{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-lg mb-4">
    <div class="card-header bg-dark text-white">Filtros</div>
    <div class="card-body">
      <form method="post" class="row g-3" autocomplete="off">
        {% csrf_token %}
        <div class="col-md-6">
          <label class="form-label">Empresa</label>
          {{ form.empresa }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Funcion√°rio (opcional)</label>
          {{ form.funcionario }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Pagamento</label>
          {{ form.data_pagamento }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Compet√™ncia √önica (MM/YYYY)</label>
          {{ form.competencia }}
          <small class="form-text text-muted">{{ form.competencia.help_text }}</small>
        </div>
        <div class="col-md-6">
          <label class="form-label">M√∫ltiplas compet√™ncias (uma por linha)</label>
          {{ form.competencias }}
          <small class="form-text text-muted">{{ form.competencias.help_text }}</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">Agrupar por</label>
          {{ form.agrupamento }}
        </div>
        <div class="col-12">
          <button id="btnGerar" class="btn btn-primary" type="submit">
            <i class="bi bi-file-bar-graph"></i> Gerar
          </button>
        </div>
      </form>
      
      <!-- Aviso sobre FGTS n√£o pagos -->
      <div class="alert alert-info mt-3 border-0" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>Importante:</strong> Este relat√≥rio calcula apenas os lan√ßamentos com FGTS <strong>n√£o pago</strong>. 
        Lan√ßamentos j√° marcados como pagos n√£o aparecem no c√°lculo.
      </div>
      
      {% if erro %}
        <div class="alert alert-warning mt-3">{{ erro }}</div>
      {% endif %}
      
      <!-- Bloco de avisos -->
      {% if avisos %}
        <div class="alert alert-warning mt-3 border-0" role="alert">
          <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Avisos durante o processamento:</strong>
          <ul class="mb-0 mt-2">
            {% for aviso in avisos %}
              <li>{{ aviso }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  </div>

  {% if resultados %}
  <div class="card shadow-lg">
    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          {{ empresa.nome }} ‚Äî 
          {% if competencias|length > 5 %}
            {{ competencias|length }} compet√™ncias
          {% else %}
            {{ competencias|join:', ' }}
          {% endif %}
          (pagamento: {{ data_pagamento|date:"d/m/Y" }})
        </h5>
      </div>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <span class="badge bg-info me-2">Agrupado por: {{ agrupamento|title }}</span>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'relatorio-competencia-export-csv' %}?empresa={{ empresa.pk }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}&competencias={{ competencias|join:'\n' }}">Exportar CSV</a>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'relatorio-competencia-export-pdf' %}?empresa={{ empresa.pk }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}&competencias={{ competencias|join:'\n' }}">Exportar PDF</a>
        <a class="btn btn-outline-primary btn-sm" href="{% url 'sefip-export' %}?empresa={{ empresa.pk }}&competencia={{ competencias.0 }}&funcionario_de=1&funcionario_ate=999999" title="Gerar arquivo SEFIP.RE para a compet√™ncia selecionada">
          SEFIP (.RE)
        </a>
      </div>

      {% if resultados_agrupados %}
        <!-- Visualiza√ß√£o Agrupada -->
        {% for grupo_key, grupo_data in resultados_agrupados %}
        <div class="mb-4">
          <h5 class="bg-light p-2 rounded">
            <i class="bi bi-folder-fill text-primary"></i> {{ grupo_data.label }}
            <span class="badge bg-secondary float-end">{{ grupo_data.items|length }} lan√ßamento(s)</span>
          </h5>
          
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>Compet√™ncia</th>
                  <th>Funcion√°rio</th>
                  <th>Base FGTS</th>
                  <th>√çndice</th>
                  <th>Corrigido</th>
                  <th>JAM</th>
                  <th>Total</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for item in grupo_data.items %}
                <tr>
                  <td><span class="badge bg-info">{{ item.competencia }}</span></td>
                  <td>{{ item.lancamento.funcionario.nome }}</td>
                  <td>R$ {{ item.lancamento.valor_fgts }}</td>
                  <td>{{ item.calc.indice }}</td>
                  <td>R$ {{ item.calc.valor_corrigido }}</td>
                  <td>R$ {{ item.calc.valor_jam }}</td>
                  <td><strong>R$ {{ item.calc.total }}</strong></td>
                  <td>
                    <a href="{% url 'relatorio-memoria-calculo' %}?empresa={{ empresa.pk }}&funcionario={{ item.lancamento.funcionario.pk }}&competencia={{ item.competencia }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}" 
                       class="btn btn-sm btn-info" 
                       title="Baixar Mem√≥ria de C√°lculo">
                      <i class="bi bi-calculator"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th colspan="4" class="text-end">Subtotal {{ grupo_data.label }}:</th>
                  <th>R$ {{ grupo_data.totais.valor_corrigido }}</th>
                  <th>R$ {{ grupo_data.totais.valor_jam }}</th>
                  <th><strong>R$ {{ grupo_data.totais.total }}</strong></th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        {% endfor %}

        <!-- Totais Gerais -->
        <div class="card bg-success text-white mt-4">
          <div class="card-body">
            <h5 class="card-title">üí∞ Totais Gerais</h5>
            <div class="row">
              <div class="col-md-4">
                <strong>Valor Corrigido:</strong><br>
                <h4>R$ {{ totais.valor_corrigido }}</h4>
              </div>
              <div class="col-md-4">
                <strong>JAM:</strong><br>
                <h4>R$ {{ totais.valor_jam }}</h4>
              </div>
              <div class="col-md-4">
                <strong>Total Geral:</strong><br>
                <h3>R$ {{ totais.total }}</h3>
              </div>
            </div>
          </div>
        </div>

      {% else %}
        <!-- Visualiza√ß√£o Simples (fallback) -->
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-dark">
              <tr>
                <th>Compet√™ncia</th>
                <th>Funcion√°rio</th>
                <th>Base FGTS</th>
                <th>√çndice</th>
                <th>Corrigido</th>
                <th>JAM</th>
                <th>Total</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for item in resultados %}
              <tr>
                <td><span class="badge bg-info">{{ item.competencia }}</span></td>
                <td>{{ item.lancamento.funcionario.nome }}</td>
                <td>R$ {{ item.lancamento.valor_fgts }}</td>
                <td>{{ item.calc.indice }}</td>
                <td>R$ {{ item.calc.valor_corrigido }}</td>
                <td>R$ {{ item.calc.valor_jam }}</td>
                <td><strong>R$ {{ item.calc.total }}</strong></td>
                <td>
                  <a href="{% url 'relatorio-memoria-calculo' %}?empresa={{ empresa.pk }}&funcionario={{ item.lancamento.funcionario.pk }}&competencia={{ item.competencia }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}" 
                     class="btn btn-sm btn-info" 
                     title="Baixar Mem√≥ria de C√°lculo">
                    <i class="bi bi-calculator"></i> Mem√≥ria
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="table-secondary">
                <th class="text-end" colspan="4">Totais:</th>
                <th>R$ {{ totais.valor_corrigido }}</th>
                <th>R$ {{ totais.valor_jam }}</th>
                <th><strong>R$ {{ totais.total }}</strong></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<script>
// Mant√©m a fun√ß√£o simples por compatibilidade com futuros upgrades
function mostrarProcessando() {
  // Fun√ß√£o vazia - n√£o interfere com o formul√°rio
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}Relatório por Competência{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-lg mb-4">
    <div class="card-header bg-dark text-white">Filtros</div>
    <div class="card-body">
      <form method="post" class="row g-3" autocomplete="off">
        {% csrf_token %}
        <div class="col-md-6">
          <label class="form-label">Empresa</label>
          {{ form.empresa }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Funcionário (opcional)</label>
          {{ form.funcionario }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Pagamento</label>
          {{ form.data_pagamento }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Competência única (MM/YYYY)</label>
          {{ form.competencia }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Múltiplas competências (uma por linha)</label>
          {{ form.competencias }}
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit"><i class="bi bi-file-bar-graph"></i> Gerar</button>
        </div>
      </form>
      {% if erro %}
        <div class="alert alert-warning mt-3">{{ erro }}</div>
      {% endif %}
    </div>
  </div>

  {% if resultados %}
  <div class="card shadow-lg">
    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ empresa.nome }} — {{ competencias|join:', ' }} (pagamento: {{ data_pagamento|date:"d/m/Y" }})</h5>
      </div>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'relatorio-competencia-export-csv' %}?empresa={{ empresa.pk }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}&competencias={{ competencias|join:'\n' }}">Exportar CSV</a>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'relatorio-competencia-export-pdf' %}?empresa={{ empresa.pk }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}&competencias={{ competencias|join:'\n' }}">Exportar PDF</a>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>Funcionário</th>
              <th>Base FGTS</th>
              <th>Índice</th>
              <th>Corrigido</th>
              <th>JAM</th>
              <th>Total</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for item in resultados %}
            <tr>
              <td>{{ item.lancamento.funcionario.nome }}</td>
              <td>R$ {{ item.lancamento.valor_fgts }}</td>
              <td>{{ item.calc.indice }}</td>
              <td>R$ {{ item.calc.valor_corrigido }}</td>
              <td>R$ {{ item.calc.valor_jam }}</td>
              <td><strong>R$ {{ item.calc.total }}</strong></td>
              <td>
                <a href="{% url 'relatorio-memoria-calculo' %}?empresa={{ empresa.pk }}&funcionario={{ item.lancamento.funcionario.pk }}&competencia={{ item.competencia }}&data_pagamento={{ data_pagamento|date:'Y-m-d' }}" 
                   class="btn btn-sm btn-info" 
                   title="Baixar Memória de Cálculo">
                  <i class="bi bi-calculator"></i> Memória
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-secondary">
              <th class="text-end">Totais:</th>
              <th></th>
              <th></th>
              <th>R$ {{ totais.valor_corrigido }}</th>
              <th>R$ {{ totais.valor_jam }}</th>
              <th><strong>R$ {{ totais.total }}</strong></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
